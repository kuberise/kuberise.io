# SA for api secrets
apiVersion: v1
kind: ServiceAccount
metadata:
  name: api-vault-sa
  namespace: api
---
# Vault auth for api secrets
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: api-vault-auth
  namespace: vault
spec:
  allowedNamespaces:
  - api
  kubernetes:
    role: api-vault-reader
    serviceAccount: api-vault-sa
    tokenExpirationSeconds: 600
  method: kubernetes
  mount: kubernetes
  namespace: api
  vaultConnectionRef: vault/default
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: api-creds
  namespace: api
spec:
  type: kv-v2                                # Specify KV store version
  mount: secret                              # KV secrets engine mount path
  path: applications/api/api-creds # Path where the secret is stored
  vaultAuthRef: vault/api-vault-auth    # Reference to the VaultAuth CR
  refreshAfter: 2h
  destination:
    name: api-creds                     # Name of the K8s Secret to create
    create: true                             # Create the Secret if it doesn't exist
    type: Opaque                             # Secret type (Opaque is default)
---
apiVersion: batch/v1
kind: Job
metadata:
  name: api-vault-policy-role-setup
  namespace: vault
  annotations:
    argocd.argoproj.io/hook: PostSync
    # Remove the HookFailed deletion policy to keep failed jobs
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
  labels:
    app.kubernetes.io/part-of: vault-setup
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 60
  template:
    metadata:
      labels:
        app.kubernetes.io/part-of: vault-setup
    spec:
      serviceAccountName: vault
      restartPolicy: Never
      containers:
      - name: vault-cli
        image: hashicorp/vault:latest
        env:
        - name: VAULT_ADDR
          value: "http://vault.vault:8200"
        # Optionally, set VAULT_TOKEN if not automatically authenticated in dev mode:
        - name: VAULT_TOKEN # FIXME: use service account instead of token for production
          value: root
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -e
          echo "Checking if secret 'secret/applications/api/api-creds' exists..."
          if vault kv get secret/applications/api/api-creds > /dev/null 2>&1; then
            echo "Secret already exists. Skipping random password generation."
          else
            echo "Generating a random password..."
            # Use the -field flag to extract the random_bytes value directly
            RANDOM_PASSWORD=$(head -c 16 /dev/urandom | base64)
            echo "Storing the random password in Vault at secret/applications/api/api-creds..."
            vault kv put secret/applications/api/api-creds password="$RANDOM_PASSWORD"
            echo "Secret stored in Vault at secret/applications/api/api-creds."
          fi

          echo "Creating Vault policy 'api-read'..."
          vault policy write api-read - <<EOF
          path "secret/data/applications/api/*" {
            capabilities = ["read", "list"]
          }
          EOF
          echo "Vault policy 'api-read' created successfully."

          echo "Enabling Kubernetes auth method in Vault (if not already enabled)..."
          vault auth enable kubernetes || echo "Kubernetes auth already enabled."

          # echo "Configuring Kubernetes auth connection to the cluster..."
          # vault write auth/kubernetes/config \
          #   token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
          #   kubernetes_host="https://kubernetes.default.svc" \
          #   kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

          echo "Creating Vault Kubernetes auth role 'api-vault-reader'..."
          vault write auth/kubernetes/role/api-vault-reader \
            bound_service_account_names="api-vault-sa" \
            bound_service_account_namespaces="api" \
            policies="api-read" \
            ttl="1h"

          echo "Vault role 'api-vault-reader' created and bound to Service Account 'vault-auth-sa' in namespace 'default'."
